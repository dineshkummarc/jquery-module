This is an outgrowth of the pseudo-code at http://gist.github.com/250544
